<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Member Login – Delta Gamma Iota</title>
  <link rel="stylesheet" href="css/styles.css" />
  <style>
    :root{
      --maroon:#7A0E19; --black:#000; --white:#fff; --offwhite:#FAF9F6; --muted:#6b6b6b;
    }
    body { background: var(--offwhite); font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; color:var(--black); }
    .login-wrapper { max-width:1000px; margin:3.5rem auto; padding:1rem; }
    .login-panel {
      max-width:480px; margin:0 auto; background:#fff; border-radius:12px; padding:2rem;
      box-shadow:0 12px 30px rgba(0,0,0,0.12); text-align:center;
    }
    .login-panel img { height:120px; display:block; margin:0 auto 1rem; }
    .login-title { font-size:1.6rem; font-weight:800; color:#1f1f1f; margin-bottom:0.4rem; }
    .login-sub { color:var(--muted); margin-bottom:1.2rem; }
    .form-row { text-align:left; margin-bottom:1rem; }
    label { display:block; font-weight:600; margin-bottom:0.35rem; font-size:0.95rem; }
    input[type="email"], input[type="password"], input[type="text"] {
      width:100%; padding:.75rem; border-radius:8px; border:1px solid rgba(0,0,0,0.12); font-size:1rem;
    }
    .btn { padding:.75rem 1.05rem; border-radius:8px; font-weight:700; cursor:pointer; border:0; }
    .btn-primary { background:var(--maroon); color:var(--white); }
    .btn-muted { background:#f2f2f2; color:#222; border:1px solid rgba(0,0,0,0.06); }
    .note { font-size:.92rem; color:#666; margin-top:.75rem; }
    .error { color:#b00020; font-weight:600; margin-top:.6rem; }
    .success { color:#0a7a0a; font-weight:600; margin-top:.6rem; }
    @media (max-width:600px){ .login-panel{ padding:1rem } .login-wrapper{ padding:0 1rem } }
    /* small helper to show user email when logged in */
    #userInfo { margin-top:10px; font-size:0.95rem; color:#333; }
  </style>
</head>
<body>

  <!-- Header (same across site) -->
  <header class="site-header">
    <div class="top-bar"><span>1965</span><span>1998</span></div>
    <div class="header-main">
      <div class="greek-letters"><span>Δ</span><span>Γ</span><span>Ι</span></div>
      <div class="chapter-name"><span>DELTA</span><span>GAMMA</span><span>IOTA</span></div>
    </div>
    <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">☰</button>
    <nav id="main-nav" class="main-nav">
      <a href="index.html">Home</a>
      <a href="cardinal-beliefs.html">Beliefs</a>
      <a href="philanthropy.html">Philanthropy</a>
      <a href="executive-council.html">Council</a>
      <a href="shop.html">Shop</a>
      <a href="dues-donations.html">Dues</a>
      <a href="login.html">Login</a>
    </nav>
  </header>

  <!-- LOGIN -->
  <main class="login-wrapper">
    <div class="login-panel" aria-live="polite">
      <img src="assets/crest.png" alt="Delta Gamma Iota Crest" />
      <div class="login-title">Member Login</div>
      <div class="login-sub">Sign in or request access to member resources.</div>

      <div id="status" class="note" aria-live="polite"></div>

      <!-- Auth0 hosted widget (redirect) -->
      <div style="margin-top:1rem;">
        <button id="auth0LoginBtn" class="btn btn-primary" style="width:100%;">Sign in / Sign up (Auth0)</button>
      </div>

      <div style="margin:0.9rem 0;" class="note">Or prefill a signup request with the form below (admin approval required).</div>

      <!-- Signup prefill form (client-side passcode check) -->
      <form id="signupForm" onsubmit="event.preventDefault(); handlePrefillSignup();" style="margin-top:0.8rem;">
        <div class="form-row">
          <label for="sEmail">Email</label>
          <input id="sEmail" type="email" placeholder="you@school.edu" required />
        </div>

        <div class="form-row">
          <label for="sPass">Password</label>
          <input id="sPass" type="password" placeholder="Choose a secure password (min 8 chars)" minlength="8" required />
        </div>

        <div class="form-row">
          <label for="sPasscode">Chapter Passcode</label>
          <!-- empty by default per request -->
          <input id="sPasscode" type="text" placeholder="Enter chapter passcode" autocomplete="off" required />
        </div>

        <div id="signupFeedback" aria-live="polite"></div>

        <div style="margin-top:0.8rem;">
          <button type="submit" class="btn btn-primary" style="width:100%;">Request Account (prefill signup)</button>
        </div>
      </form>

      <div style="margin-top:0.9rem;">
        <button id="logoutBtn" class="btn btn-muted" style="width:100%; display:none;">Sign Out</button>
      </div>

      <div class="note" style="margin-top:1rem;">
        After signing up via Auth0, an administrator must approve/assign roles in Auth0 if you require approval. You will receive an email confirmation from Auth0 if email verification is enabled.
      </div>

      <div id="userInfo" style="display:none;"></div>
    </div>
  </main>

  <!-- Footer (same as site) -->
  <footer class="site-footer">
    <div class="footer-inner">
      <div class="footer-title">Contact Us</div>
      <div class="footer-contact">
        <a href="mailto:deltagammaiota2@gmail.com"><img src="assets/email-icon.png" class="icon"> deltagammaiota2@gmail.com</a>
        <a href="https://www.instagram.com/deltagammaiota/?hl=en" target="_blank"><img src="assets/instagram-icon.png" class="icon"> Instagram</a>
      </div>
    </div>
  </footer>

  <!-- Auth0 SPA SDK -->
  <script src="https://cdn.auth0.com/js/auth0-spa-js/2.0/auth0-spa-js.production.js"></script>

  <script>
    // ====== CONFIG ======
    const AUTH0_DOMAIN = "dev-hu8eek57hiyfzcts.us.auth0.com";
    const AUTH0_CLIENT_ID = "xjYAzMY8g40A6QiRUcJpeIyWGxMqzA2V";
    const REDIRECT_URI = window.location.origin + "/members/dashboard.html"; // callback
    const REQUIRED_PASSCODE = "1965"; // chapter passcode required for signup prefill
    // ====================

    let auth0Client;

    async function configureAuth0() {
      auth0Client = await createAuth0Client({
        domain: AUTH0_DOMAIN,
        client_id: AUTH0_CLIENT_ID,
        authorizationParams: {
          redirect_uri: REDIRECT_URI,
        }
      });

      // If returning from Auth0 redirect
      if (window.location.search.includes("code=") && window.location.search.includes("state=")) {
        try {
          const result = await auth0Client.handleRedirectCallback();
          // After handling, redirect to the dashboard (clean URL)
          window.history.replaceState({}, document.title, "/members/dashboard.html");
        } catch (err) {
          console.error("Error handling redirect callback:", err);
        }
      }

      // Update UI if already authenticated
      const isAuthenticated = await auth0Client.isAuthenticated();
      updateUI(isAuthenticated);
    }

    function updateUI(isAuthenticated) {
      const status = document.getElementById('status');
      const logoutBtn = document.getElementById('logoutBtn');
      const auth0LoginBtn = document.getElementById('auth0LoginBtn');
      const userInfo = document.getElementById('userInfo');

      if (isAuthenticated) {
        auth0Client.getUser().then(user => {
          status.textContent = "Signed in as " + (user.email || user.name || "");
          logoutBtn.style.display = "block";
          auth0LoginBtn.style.display = "none";
          userInfo.style.display = "block";
          userInfo.textContent = "Welcome, " + (user.name || user.email || "");
        });
      } else {
        status.textContent = "";
        logoutBtn.style.display = "none";
        auth0LoginBtn.style.display = "inline-block";
        userInfo.style.display = "none";
      }
    }

    // Wire up UI
    document.addEventListener('DOMContentLoaded', async () => {
      await configureAuth0();

      document.getElementById('auth0LoginBtn').addEventListener('click', async () => {
        // default redirect to Auth0 hosted login
        await auth0Client.loginWithRedirect();
      });

      document.getElementById('logoutBtn').addEventListener('click', async () => {
        await auth0Client.logout({
          logoutParams: { returnTo: window.location.origin + "/login.html" }
        });
        updateUI(false);
      });
    });

    // Signup prefill (client-side passcode check)
    async function handlePrefillSignup() {
      const email = document.getElementById('sEmail').value.trim();
      const pass = document.getElementById('sPass').value;
      const passcode = document.getElementById('sPasscode').value.trim();
      const feedback = document.getElementById('signupFeedback');

      feedback.textContent = "";

      if (!email || pass.length < 8) {
        feedback.innerHTML = '<div class="error">Please provide a valid email and choose a password of at least 8 characters.</div>';
        return;
      }

      // client-side gate for passcode
      if (passcode !== REQUIRED_PASSCODE) {
        feedback.innerHTML = '<div class="error">Invalid chapter passcode.</div>';
        return;
      }

      // We can't programmatically create an Auth0 user from client JS (would require Management API).
      // The safest option: redirect to the hosted signup page and prefill the email.
      feedback.innerHTML = '<div class="note">Redirecting to secure signup page…</div>';

      // Sign-up redirect: screen_hint=signup instructs hosted page to show signup
      // prefill email using login_hint (Auth0 will try to prefill but may depend on hosted UI settings)
      await auth0Client.loginWithRedirect({
        authorizationParams: {
          screen_hint: 'signup',
          login_hint: email
        }
      });
    }
  </script>

  <script>
    function toggleMobileMenu() {
      document.getElementById('main-nav').classList.toggle('open');
    }
  </script>
</body>
</html>
