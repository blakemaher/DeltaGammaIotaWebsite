<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Member Login – Delta Gamma Iota</title>
  <link rel="stylesheet" href="css/styles.css" />
  <style>
    /* Local overrides for a clean professional login box */
    body { background: var(--offwhite); }
    .login-wrapper { max-width:1000px; margin:3.5rem auto; padding:1rem; }
    .login-panel {
      max-width:460px;
      margin:0 auto;
      background:#fff;
      border-radius:12px;
      padding:2rem;
      box-shadow:0 10px 30px rgba(0,0,0,0.12);
      text-align:center;
    }
    .login-panel img { height:120px; display:block; margin:0 auto 1rem; }
    .login-title { font-size:1.6rem; font-weight:800; color:#1f1f1f; margin-bottom:0.6rem;}
    .login-sub { color:var(--muted); margin-bottom:1.2rem; }
    .form-group { text-align:left; margin-bottom:1rem; }
    .form-group label { display:block; margin-bottom:.35rem; font-weight:600; font-size:.95rem;}
    input[type="email"], input[type="password"], input[type="text"] {
      width:100%; padding:.75rem; border-radius:8px; border:1px solid rgba(0,0,0,0.12);
      font-size:1rem;
    }
    .row { display:flex; gap:.75rem; }
    .btn { display:inline-block; padding:.7rem 1.05rem; border-radius:8px; font-weight:700; cursor:pointer; }
    .btn-primary { background:var(--maroon); color:#fff; border:none; }
    .btn-muted { background:#f2f2f2; color:#222; border:1px solid rgba(0,0,0,0.06); }
    .note { font-size:.9rem; color:#666; margin-top:.8rem; }
    .error { color:#b00020; font-weight:600; margin-top:.6rem; }
    .success { color:#0a7a0a; font-weight:600; margin-top:.6rem; }
    @media (max-width:600px) { .login-wrapper { padding:0 1rem; } .login-panel{ padding:1.1rem } }
  </style>
</head>
<body>

  <!-- HEADER (same as site) -->
  <header class="site-header">
    <div class="top-bar"><span>1965</span><span>1998</span></div>
    <div class="header-main">
      <div class="greek-letters"><span>Δ</span><span>Γ</span><span>Ι</span></div>
      <div class="chapter-name"><span>DELTA</span><span>GAMMA</span><span>IOTA</span></div>
    </div>
    <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">☰</button>
    <nav id="main-nav" class="main-nav">
      <a href="index.html">Home</a>
      <a href="cardinal-beliefs.html">Beliefs</a>
      <a href="philanthropy.html">Philanthropy</a>
      <a href="executive-council.html">Council</a>
      <a href="shop.html">Shop</a>
      <a href="dues-donations.html">Dues</a>
      <a href="login.html">Login</a>
    </nav>
  </header>

  <!-- LOGIN UI -->
  <main class="login-wrapper">
    <div class="login-panel" aria-live="polite">
      <!-- Centered crest -->
      <img src="assets/crest.png" alt="Delta Gamma Iota Crest" />

      <div class="login-title">Member Login</div>
      <div class="login-sub">Enter your credentials to access member resources.</div>

      <!-- LOGIN FORM (we use Netlify Identity widget for sign-in, custom sign-up below) -->
      <div id="statusMessage" class="note"></div>

      <div style="margin:1rem 0 0.6rem;">
        <button id="open-login-widget" class="btn btn-primary" style="width:100%;">Sign in / Create account</button>
      </div>

      <div class="note">Or use the form below to create an account (admin approval required).</div>

      <!-- SIGNUP FORM / PASSCODE CHECK: requires chapter passcode 1965 -->
      <form id="signupForm" style="margin-top:1rem;" onsubmit="event.preventDefault(); handleSignup();">
        <div class="form-group">
          <label for="signupEmail">Email</label>
          <input id="signupEmail" type="email" placeholder="you@school.edu" required>
        </div>

        <div class="form-group">
          <label for="signupPassword">Password</label>
          <input id="signupPassword" type="password" placeholder="Choose a secure password" minlength="8" required>
        </div>

        <div class="form-group">
          <label for="chapterPasscode">Chapter Passcode</label>
          <!-- empty input by default, user types '1965' to proceed -->
          <input id="chapterPasscode" type="text" placeholder="Enter chapter passcode" autocomplete="off" required>
        </div>

        <div id="signupFeedback" role="status" aria-live="polite"></div>

        <div style="margin-top:1rem;">
          <button type="submit" class="btn btn-primary" style="width:100%;">Request Account</button>
        </div>
      </form>

      <div style="margin-top:0.9rem;">
        <button id="signOutBtn" class="btn btn-muted" style="width:100%; display:none;">Sign Out</button>
      </div>

      <div class="note" style="margin-top:1rem;">
        After signing up, an administrator must approve your account. Once approved you will be assigned the member role and can access member-only pages.
      </div>
    </div>
  </main>

  <!-- FOOTER (same as site) -->
  <footer class="site-footer">
    <div class="footer-inner">
      <div class="footer-title">Contact Us</div>
      <div class="footer-contact">
        <a href="mailto:deltagammaiota2@gmail.com"><img src="assets/email-icon.png" class="icon"> deltagammaiota2@gmail.com</a>
        <a href="https://www.instagram.com/deltagammaiota/?hl=en" target="_blank"><img src="assets/instagram-icon.png" class="icon"> Instagram</a>
      </div>
    </div>
  </footer>

  <!-- Netlify Identity widget -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

  <script>
    // ---- Helper UI hooks ----
    const openWidgetBtn = document.getElementById('open-login-widget');
    const signOutBtn = document.getElementById('signOutBtn');
    const statusEl = document.getElementById('statusMessage');
    const signupFeedback = document.getElementById('signupFeedback');

    // Initialize the widget
    const identity = netlifyIdentity; // global from the widget script
    identity.on('init', user => {
      updateUI(user);
    });
    identity.on('login', user => {
      updateUI(user);
      identity.close();
    });
    identity.on('logout', () => {
      updateUI(null);
    });
    identity.on('signup', () => {
      // optional: close default widget on signup
    });
    identity.init();

    function updateUI(user) {
      if (user) {
        statusEl.textContent = 'Signed in as ' + (user.email || user.user_metadata?.full_name || '');
        signOutBtn.style.display = 'block';
        openWidgetBtn.style.display = 'none';
      } else {
        statusEl.textContent = '';
        signOutBtn.style.display = 'none';
        openWidgetBtn.style.display = 'inline-block';
      }
    }

    // Open netlify identity widget for login / social / classic flow
    openWidgetBtn.addEventListener('click', () => {
      identity.open(); // shows the default widget (login / signup)
    });

    signOutBtn.addEventListener('click', () => {
      identity.logout();
      updateUI(null);
    });

    // ---- Custom signup flow with chapter passcode check ----
    // Note: This form POSTS to Netlify's identity signup endpoint.
    async function handleSignup() {
      signupFeedback.textContent = '';
      const email = document.getElementById('signupEmail').value.trim();
      const password = document.getElementById('signupPassword').value;
      const passcode = document.getElementById('chapterPasscode').value.trim();

      // Client-side passcode check (user must provide 1965)
      if (passcode !== '1965') {
        signupFeedback.innerHTML = '<div class="error">Invalid chapter passcode.</div>';
        return;
      }

      // POST to Netlify Identity signup endpoint (available when site is hosted on Netlify)
      try {
        signupFeedback.innerHTML = '<div class="note">Submitting request…</div>';
        const res = await fetch('/.netlify/identity/signup', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        const json = await res.json();

        if (!res.ok) {
          // show the message from Netlify if available
          signupFeedback.innerHTML = '<div class="error">' + (json?.msg || json?.error || 'Signup failed') + '</div>';
          return;
        }

        // success message
        signupFeedback.innerHTML = '<div class="success">Signup request sent. Please check your email to confirm. An admin must approve your account.</div>';
        // Note: Admin will assign the "member" role via Netlify UI (or via API).
      } catch (err) {
        signupFeedback.innerHTML = '<div class="error">Network error. Try again later.</div>';
        console.error(err);
      }
    }
  </script>

  <script>
    function toggleMobileMenu() {
      document.getElementById('main-nav').classList.toggle('open');
    }
  </script>

</body>
</html>
